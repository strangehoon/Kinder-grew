# 🖐킨더그루
![M1](https://user-images.githubusercontent.com/108935568/232361653-b736e3fa-ff7e-4881-8c40-d72fd7eaac81.png)

## 📝 개요

* **프로젝트명** : 킨더그루

* **주제** : 유치원이 아이의 교육에 보다 집중할 수 있도록 아이 관리를 지원하는 통합 관리 서비스


* **기간** : 2023년 3월 10일 ~ 2023년 4월 21일

* **프론트엔드 깃허브** : [킨더그루 FrontEnd](https://github.com/HangHae-12/Front)
* **팀 노션** : [팀 노션 바로가기](https://www.notion.so/f4e7bbe6c3cb40689064a4c566b91144https://www.notion.so/f4e7bbe6c3cb40689064a4c566b91144)

* **팀원**
 
    | 이름 | FE/BE | Github|
    | :------:| :-----:| :---|
    | 백주원 | FE | https://github.com/baekjoowon |
    | 황재연 | FE | https://github.com/yeonso08 |
    | 우주호 | FE | https://github.com/Cupcakes33 |
    | 홍예석 | BE | https://github.com/yshong1998 |
    | 이상훈 | BE | https://github.com/strangehoon |
    | 김근호 | BE | https://github.com/GEUNHOKIM |
    | 김현호 | BE | https://github.com/cho-coding |
  
</br>

## 🕸 아키텍쳐

<img src = "https://user-images.githubusercontent.com/117654450/234284146-d7c93c77-29a2-4e14-9b31-f54aeef08481.png" height = "520px" width = "920px" allign = "left">

</br>

</br>

## ⚒ 기술스택


<img src="https://img.shields.io/badge/SpringBoot-6DB33F?style=flat&logo=SpringBoot&logoColor=white"/> <img src="https://img.shields.io/badge/Spring Data Jpa-E31E52?style=flat&logo=Spring Data Jpa&logoColor=white"/>
<img src="https://img.shields.io/badge/Querydsl-0096D6?style=flat&logo=Querydsl&logoColor=white"/> <img src="https://img.shields.io/badge/Spring Security-6DB33F?style=flat&logo=Spring Security&logoColor=white"/>
<img src="https://img.shields.io/badge/Redis-DC382D?style=flat&logo=Redis&logoColor=white"/>
<img src="https://img.shields.io/badge/MySql-4479A1?style=flat&logo=MySql&logoColor=white"/>
<img src="https://img.shields.io/badge/Gradle-02303A?style=flat&logo=Gradle&logoColor=white"/>
<img src="https://img.shields.io/badge/Amazon S3-569A31?style=flat&logo=Amazon S3&logoColor=white"/>
<img src="https://img.shields.io/badge/Amazon EC2-FF9900?style=flat&logo=Amazon EC2&logoColor=white"/>
<img src="https://img.shields.io/badge/Amazon RDS-527FFF?style=flat&logo=Amazon RDS&logoColor=white"/>
<img src="https://img.shields.io/badge/GitHub Actions-2088FF?style=flat&logo=GitHub Actions&logoColor=white"/>
<img src="https://img.shields.io/badge/GitHub-181717?style=flat&logo=GitHub&logoColor=white"/>
<img src="https://img.shields.io/badge/NGINX-009639?style=flat&logo=NGNIX&logoColor=white"/>
<img src="https://img.shields.io/badge/Kakao Login-FFCD00?style=flat&logo=Kakao Login&logoColor=white"/>

</br>

## 💡 주요 기능
<details>
<summary>접기/펼치기</summary> </br>

* **1. 간편한 소셜 로그인**

    <img src = "https://user-images.githubusercontent.com/117654450/234538360-395de2cd-afde-4694-b909-0fabd5f39fe2.png" height = "320px" width = "470px">
    <img src = "https://user-images.githubusercontent.com/117654450/235284914-8945089a-5643-40f3-a06f-40d68dbeff14.png" height = "320px" width = "470px"></br>


</br>

* **2. 등하원 관리 서비스**
  * 실시간 등 하원 처리
      
      <img src = "https://user-images.githubusercontent.com/117654450/234483406-32480928-252e-40bf-9e30-ba7aae550a58.png" height = "420px" width = "820px" allign = "left"> </br> 
  
  * 실시간 알림 기능(학부모 등,하원 카톡 전송)
      
      <img src = "https://user-images.githubusercontent.com/117654450/234485164-55a3bfbd-07b6-4648-8e67-67708bf4bd6a.png" height = "370px" width = "260px">
  </br>
  
* **3. 출결 관리 서비스**
  * 월별 출석부(+ 엑셀 내보내기 기능)
      
      <img src = "https://user-images.githubusercontent.com/117654450/234496232-5cc71f84-11ab-4cf9-a0d1-228c82a7bfdd.png" height = "420px" width = "820px" allign = "left"></br>
 
  * 일별 출석부(+ 엑셀 내보내기 기능)
      
      <img src = "https://user-images.githubusercontent.com/117654450/234496601-2e95a9a9-14e8-49d7-a1ad-41dbe0d74961.png" height = "420px" width = "820px" allign = "left"></br>
  
  * 결석 신청 및 취소
       
      <img src = "https://user-images.githubusercontent.com/117654450/234487420-9492853d-fe34-4d4c-aba9-d7665709fef2.png" height = "420px" width = "820px" allign = "left">
</br>
  
* **4. 유치원 운영관리 서비스**
  * 반 별 갤러리
  
      <img src = "https://user-images.githubusercontent.com/117654450/234488736-479d07fc-b259-4d1c-a7a8-eb84a61ee138.png" height = "420px" width = "820px" allign = "left"></br>
      <img src="https://user-images.githubusercontent.com/117654450/234500749-a0a09263-3985-4839-b843-f08a9a660134.png" height="370px" width="260px" style="margin-right: 120px;"/></br>

  * 아이 정보 열람
      
      <img src = "https://user-images.githubusercontent.com/117654450/234489012-69b8e02f-4d70-4be0-9bad-f868d3305490.png" height = "420px" width = "820px" allign = "left">  
      <img src = "https://user-images.githubusercontent.com/117654450/234502045-2190f05b-2e8e-4615-a0f9-ef5c8a3752f9.png" height = "370px" width = "260px" allign = "left">

</details>

</br>

## 📝 API 명세

[킨더그루 팀 노션 바로가기](https://www.notion.so/f4e7bbe6c3cb40689064a4c566b91144)

</br>

## 📊 ERD

<img src = "https://user-images.githubusercontent.com/106438992/235306217-5bf8b84b-f0c2-4235-9827-557dd182c917.png" allign = "left"> 


## 🤝 협업방식

### TEAM RULE
- 전체회의시간: 저녁 8시
- BE 회의시간: 저녁 5시 30분
   - 코드리뷰
   - 이슈 공유하기
   - 진행 상황 공유하기 
- 적어도 회의 시간에는 비디오와 음성 키기
- 기능 단위로 커밋하기
- pr 템플릿 양식 준수하기
- Issue 템플릿 양식 준수하기
- 머지하고 나서 브랜치 꼭 지우기
- 풀 당기기 전에 패치하기
- [프로그래밍 컨벤션 준수하기](https://www.notion.so/f4e7bbe6c3cb40689064a4c566b91144)


</br>

## ⚖️ 기술적 의사결정

</br>

| 기술 | 선택지 | 이유 |
| :------: | :--- | :--- |
| Redis    | 1. DB 저장<br>2. Redis | 유치원이라는 특성상, 선생님이 접속을 오래 하고 있기 때문에 Refresh Token이 필요하다고 생각이 들었다. <br> Refresh Token을 DB에 저장 해서 사용을 해도 되지만, 그렇게 되면 스케줄러를 사용해서 직접 만료 된 Refresh Token을 삭제 해줘야 하기도 하고 , 캐시인 Redis가 더 가볍고 속도도 빠르고 TTL을 통해서 자동으로 삭제도 가능하기 때문에 Redis를 적용 해보기로 했다.|
| ImageIO | 1. Marvin open source Library 2. Graphics2D 3. ImageIO | 처음에는 이미지를 S3에 업로드만 했기 때문에 별도의 이미지에 대한 처리를 하지 않았지만, 이미지를 리사이징해야 할 필요성이 생기면서 이미지 리사이징 방법을 고민해야 했다. 가장 먼저 Marvin open source Library를 사용해 리사이징했지만 이미지가 심해게 도트화되는 문제와 프로젝트 전체 용량보다 marvin 라이브러리의 용량이 약 3배 더 컸으며, 처리 성능 저하 문제도 있었다. 따라서 java.awt 패키지의 Graphics2D 클래스를 이용해 별도의 라이브러리 추가 사용 없이 구현을 해 보았지만 성능은 개선되었지만 도트화가 더욱 심각해지는 문제가 있었다. 따라서 Graphics2D 대신 ImageIO클래스를 이용해 리사이징하는 방법을 채택했다. 도트화가 아예 없는 것은 아니었지만 다른 2개의 방법에 비해 정도가 낮았으며 별도의 라이브러리 설치도 필요없었고, 성능도 Graphics2D와 큰 차이를 보이지 않았기 때문이다. |
| 카카오 알림 기능 | 1. 프론트엔드에서 알림 구현 </br> 2. 백엔드에서 알림 구현 | 프론트엔드, 백엔드 모두 카카오 알림 기능을 구현할 수 있지만 다음과 같은 이유로 백엔드에서 처리하기로 했다. </br> 1. 트랜잭션 </br> 단순 카카오 알림 기능 뿐만 아니라 아이의 등하원 상태도 바뀌어야 하므로 프론트엔드에서 처리 시 카카오 알림 메시지 API 뿐만 아니라 등하원 상태 변경 API도 필요했다. 하지만 서버에서는 API 하나로 같은 트랜잭션에서 처리할 수 있다. 이로인해 카카오 알림 기능과 등하원 상태 변경을 묶어서 일관성을 보장할 수 있었다. </br> 2. 보안</br> 카카오 메시지 API를 사용하는 경우, 보안상 중요한 kakaoId와 AccessToken이 필요하다. 이를 프론트엔드에서 처리하면, 이 정보가 브라우저에서 노출되거나 탈취될 수 있다. 따라서 백엔드에서 처리하면, 안전한 환경에서 이 정보들을 처리할 수 있다.|
| 복잡한 동적 쿼리 작성 | 1. JPA 쿼리 메서드 </br> 2. @Query </br> 3. QueryDSL | 기존의 JPA 쿼리 메서드는 동적 쿼리를 작성하는데 한계가 있었다. 그래서 스프링 데이터 JPA의 @Query를 사용하려 했다. @Query도 동적 쿼리 작성이 가능하므로 좋은 대안이라고 생각했으나 그래도 주어진 문제에 적용하기에는 고려해야 할 조건이 너무 많다고 생각했다. 무엇보다도 가독성이 너무 떨어져 유지보수하기 어렵다고 생각했다. 반면 QueryDSL의 where 다중 파라미터 방식은 주어진 문제의 조건들을 동적으로 커스튬할 수 있을 거라 생각했다. 이 외에도 컴파일 에러를 잡을 수 있을 뿐만 아니라 @Query보다 쿼리 자체의 가독성이 훨씬 좋다는 점도 QueryDSL을 도입한 이유였다.



</br>

## 🔨 트러블슈팅


- [회원 가입 시, 단일 테이블 전략과 맞지 않는 문제](https://github.com/HangHae-12/back/wiki/%ED%9A%8C%EC%9B%90-%EA%B0%80%EC%9E%85-%EC%8B%9C,-%EB%8B%A8%EC%9D%BC-%ED%85%8C%EC%9D%B4%EB%B8%94-%EC%A0%84%EB%9E%B5%EA%B3%BC-%EB%A7%9E%EC%A7%80-%EC%95%8A%EB%8A%94-%EB%AC%B8%EC%A0%9C)
- [미세먼지API Dto에 기본생성자를 추가해도 존재하지 않다는 오류](https://github.com/HangHae-12/back/wiki/%EB%AF%B8%EC%84%B8%EB%A8%BC%EC%A7%80API-Dto%EC%97%90-%EA%B8%B0%EB%B3%B8%EC%83%9D%EC%84%B1%EC%9E%90%EB%A5%BC-%EC%B6%94%EA%B0%80%ED%95%B4%EB%8F%84-%EC%A1%B4%EC%9E%AC%ED%95%98%EC%A7%80-%EC%95%8A%EB%8B%A4%EB%8A%94-%EC%98%A4%EB%A5%98)



</br>

## 🛠 프로젝트 후 혼자서 진행한 리팩토링

다음은 프로젝트가 끝나고 제가 혼자서 진행한 내용들입니다. 
 
### 1. QueryDSL 성능 개선
>💡 자세한 내용은 [QueryDSL을 이용한 동적 쿼리 생성 및 성능 개선](https://velog.io/@strangehoon/QueryDSL#%EC%88%98%EC%A0%95%ED%95%9C-querydsl-%EC%BD%94%EB%93%9C) 참고 바랍니다.

이전에 작성한 코드에서 다음과 같은 사항들을 고려하여 리팩토링했습니다. 

**First** : 불필요한 cross join과 distinct 메서드 제거 </br>
**Second** : where절 중복 조건 제거 </br>
**Third** : attendance 테이블의 date 컬럼 인덱스 적용 </br>
**Fourth** : PageableExecutionUtils를 통한 count 쿼리 최적화 </br>

**수정한 QueryDSL 코드**
```java
@RequiredArgsConstructor
@Repository
public class ChildRepositoryImpl implements ChildRepositoryCustom{

    private final JPAQueryFactory queryFactory;

    @Override
    public Page<ChildScheduleResponseDto> findChildSchedule(Long classroomId, Long kindergartenId, CommuteStatus commuteStatus, String time, Pageable pageable,
                                                                              InfoDto info, List<ClassroomInfoDto> everyClass){
        List<ChildScheduleResponseDto> result = queryFactory
                .select(new QChildScheduleResponseDto(
                        child.id,
                        child.name,
                        child.profileImageUrl,
                        attendance.enterTime,
                        attendance.exitTime,
                        attendance.status
                ))
                .from(attendance)
                .join(attendance.child, child)
                .join(child.classroom, classroom)
                .join(classroom.kindergarten, kindergarten)
                .where(classroomIdAndKindergartenIdIs(classroomId, kindergartenId), stateIs(commuteStatus),
                        timeIs(commuteStatus, time))
                .orderBy(child.name.asc())
                .offset(pageable.getOffset())
                .limit(pageable.getPageSize())
                .fetch();

        JPAQuery<Attendance> total = queryFactory
                .select(attendance)
                .from(attendance)
                .join(attendance.child, child)
                .join(child.classroom, classroom)
                .join(classroom.kindergarten, kindergarten)
                .where(classroomIdAndKindergartenIdIs(classroomId, kindergartenId), stateIs(commuteStatus),
                        timeIs(commuteStatus, time));

        return PageableExecutionUtils.getPage(result, pageable, total::fetchCount);
    }

    private BooleanExpression classroomIdAndKindergartenIdIs(Long classroomId, Long kindergartenId) {
        return classroomId != null ? child.classroom.id.eq(classroomId).and(classroom.kindergarten.id.eq(kindergartenId)) : classroom.kindergarten.id.eq(kindergartenId);
    }

    private BooleanExpression stateIs(CommuteStatus commuteStatus){
        if(commuteStatus.equals(ENTER)){
            return attendance.exitTime.isNull().and(attendance.date.eq(LocalDate.now())).and(attendance.status.ne(결석));
        }
        else if(commuteStatus.equals(EXIT)) {
            return attendance.enterTime.isNotNull().and(attendance.date.eq(LocalDate.now())).and(attendance.status.ne(결석));
        }
        else
            return null;
    }

    private BooleanExpression timeIs(CommuteStatus commuteStatus, String time) {
        if(commuteStatus.equals(ENTER)){
            return time != null ? child.dailyEnterTime.eq(time) : null;
        }
        else
            return time != null ? child.dailyExitTime.eq(time) : null;
    }
}
```


 
 

